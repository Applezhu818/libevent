version: 2.1.5.{build}
shallow_clone: true

#os: Visual Studio 2015 RC
os: Windows Server 2012 R2

#build:
#         verbosity: detailed

environment:
    global:
        CYG_ROOT:   C:/cygwin
        CYG_MIRROR: http://cygwin.mirror.constant.com
        CYG_CACHE:  C:/cygwin/var/cache/setup

init:
    - 'echo Building libevent Windows'
    - 'echo System architecture: %PLATFORM%'
    - 'echo Repo build branch is: %APPVEYOR_REPO_BRANCH%'
    - 'echo Build folder is: %APPVEYOR_BUILD_FOLDER%'

install:
    - '%CYG_ROOT%\setup-x86.exe -qnNdO -R "%CYG_ROOT%" -s "%CYG_MIRROR%" -l "%CYG_CACHE%" -P autoconf -P automake -P bison -P gcc-core -P gcc-g++ -P mingw-runtime -P mingw-binutils -P mingw-gcc-core -P mingw-gcc-g++ -P mingw-pthreads -P mingw-w32api -P libtool -P make -P python -P gettext-devel -P gettext -P intltool -P libiconv -P pkg-config -P openssl-devel'
    - '%CYG_ROOT%/bin/bash -lc "cygcheck -dc cygwin"'
    - 'echo Done setting up Cygwin'
    #- appveyor DownloadFile https://strcpy.net/packages/Win32OpenSSL-1_0_2a.exe
    #- Win32OpenSSL-1_0_2a.exe /silent /verysilent /sp- /suppressmsgboxes

build_script:
    #- cmd: 'echo "C:\MinGW /mingw" >%CYG_ROOT%/etc/fstab'
    #- cmd: 'C:\MinGW\bin\mingw-get install autotools autoconf automake'
    #
    - cmd: 'echo Cygwin root is: %CYG_ROOT%'
    - cmd: 'echo Build folder is: %APPVEYOR_BUILD_FOLDER%'
    - cmd: 'echo Repo build branch is: %APPVEYOR_REPO_BRANCH%'
    - cmd: 'echo Repo build commit is: %APPVEYOR_REPO_COMMIT%'
    - cmd: 'echo Autogen running...'
    - cmd: '%CYG_ROOT%/bin/bash -lc "cd $APPVEYOR_BUILD_FOLDER; exec 0</dev/null; NOCONFIGURE=1 ./autogen.sh'
    - cmd: 'echo Configure running...'
    - cmd: '%CYG_ROOT%/bin/bash -lc "cd $APPVEYOR_BUILD_FOLDER; exec 0</dev/null; ./configure"'
    - cmd: '%CYG_ROOT%/bin/bash -lc "cd $APPVEYOR_BUILD_FOLDER; echo 0</dev/null; cat evconfig-private.h config.h"'
    - cmd: '%CYG_ROOT%/bin/bash -lc "cd $APPVEYOR_BUILD_FOLDER; exec 0</dev/null; make"'
    - cmd: '%CYG_ROOT%/bin/bash --login -lc "export CYGWIN=winsymlinks:native; cd $APPVEYOR_BUILD_FOLDER; exec 0</dev/null; make verify"' 

    #- cmd: 'echo Autogen running...'
    #- cmd: '%CYG_ROOT%/bin/bash -lc "export CYGWIN=winsymlinks:native; cd $APPVEYOR_BUILD_FOLDER; exec 0</dev/null;mount C:/MinGW /mingw; bash -x ./autogen.sh; ./configure; make; make verify"'
    #- 'echo Done setting up Cygwin'


#install:
#  - appveyor DownloadFile https://strcpy.net/packages/Win32OpenSSL-1_0_2a.exe 
#  - Win32OpenSSL-1_0_2a.exe /silent /verysilent /sp- /suppressmsgboxes
#build_script:
#  - md build
#  - cd build
#  - cmake ..
#  - cmake --build .
#  - ctest --output-on-failure
cache:
  - C:\OpenSSL-Win32
